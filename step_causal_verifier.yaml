- name: step_causal_verifier_agent
  _target_: verl.experimental.agent_loop.step_causal_verifier.StepCausalVerifierAgentLoop

  step_verify:
    judge_max_concurrency: 96

    judge_backend: local
    judge_model_name_or_path: /home/projects/hku-medai/larrypl/code/mq/causal-reasoning/hf_models/gsm8k_deberta_regression
    judge_device: cpu
    judge_dtype: float32

    pns_mode: float
    pns_seqcls_enable: true
    pns_float_no_retry: false
    pns_penalty_scale: 0.1

    # 保持与 judge 训练一致的输入分布
    pns_prompt_template: |-
      Question:
      {problem}

      Prefix steps:
      {subproblem}

      Candidate step:
      {answer}

      pns=

    pns_max_new_tokens: 8
    pns_temperature: 0.0
    pns_top_p: 1.0

    # 更严格的阈值 + 给失败负奖励：推动它别乱写、别一口气写完
    pns_threshold: 0.75
    pns_pass_reward: 0.10
    pns_fail_reward: -0.05
    pns_max_retries: 2
    pns_exceed_retry_penalty: 0.10

    pns_feedback_template: |-
      This step is not acceptable.
      Rewrite ONLY this single step and try again. Requirements:
      - Exactly ONE coherent reasoning step (1-3 sentences)
      - Do NOT add multiple steps at once
      - Do NOT provide the final answer and do NOT include "<ANSWER>"
      - Keep it short

    pns_ok_continue_msg: |-
      Good. Continue with the next step (one step only).

    # 关键：final 只输出答案，避免被 256 截断导致解析失败
    pns_ok_finish_msg: |-
      Good. Output ONLY the final answer and end with:
      <ANSWER>number</ANSWER>

    pns_proceed_after_penalty_msg: |-
      Too many retries. Proceed to the next step anyway (one step only).

    pns_max_steps: 32

    # 关键：不要按回合数缩放，允许过程奖励累积，否则天然偏好少回合
    step_scale_by_num_turns: false
    step_total_weight: 0.8
    step_clip_min: -1.0
    step_clip_max: 1.0

    final_enable: true
    final_weight: 1.0
    final_mode: answer
    final_llm_enable: false
